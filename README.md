# Power BI Embedded JavaScript Demo â€” Organization Owns Data (User Owns Data)

> **Note:** This documentation was generated by GitHub Copilot and should be reviewed for accuracy and completeness before use in production or distribution.

This demo embeds a Power BI report for signed-in users in your organization using:

- Client: [`powerbi-client` JavaScript SDK](https://github.com/microsoft/PowerBI-JavaScript)
- Auth: MSAL Browser (Azure AD/Entra ID) to get a user token
- Server: Tiny Express server to serve static files only

This is the "Embed for your organization" scenario (also known as "User owns data"). Each viewer must sign in and have access to the report in Power BI.

## Prerequisites

> **Note:** This section was generated by GitHub Copilot and should be reviewed for accuracy and completeness.

1. Power BI account with access to the target workspace and report.
2. Azure AD (Entra ID) App Registration configured as a SPA:
   - Platform: Single-page application
   - Redirect URI: `http://localhost:3000`
   - Supported account types: your choice (Single tenant recommended for demos)
1. **Azure AD (Entra ID) App Registration**
   - You must register an application in Azure AD and configure it as a Single-Page Application (SPA) before setup. See the [Azure AD App Registration: Setup Guide](#azure-ad-app-registration-setup-guide) below for step-by-step instructions.
2. Power BI account with access to the target workspace and report.
3. API permissions (Delegated) on the Power BI Service:
   - `Report.Read.All` (required to embed reports)
   - Optionally `Dataset.Read.All` if you will call dataset APIs
   - Grant admin consent for your tenant
4. Ensure the signed-in user has permission to view the report in the workspace.
5. Node.js 18+ recommended.

## Setup

> **Note:** This section was generated by GitHub Copilot and should be reviewed for accuracy and completeness.

1. Install dependencies:

   ```bash
   cd samples/org-owns-data
   npm install
   ```

2. Create a `.env` (optional):

   ```bash
   cp .env.example .env
   ```

   Optionally set `PORT` (defaults to `3000`).

3. Configure the client:

   - Open `src/public/config.js` and fill in:
     - `AAD_CLIENT_ID` with your App Registration's client ID
     - `AAD_TENANT_ID` with your tenant ID (or `common`/`organizations`)
     - `POWER_BI_WORKSPACE_ID` and `POWER_BI_REPORT_ID`
     - Adjust `POWER_BI_APP_URL` if using a national cloud (e.g., GCC `https://app.powerbigov.us`)

4. Start the app:

   ```bash
   npm run start
   # or:
   npm run dev
   ```

5. Open http://localhost:3000

   - Click "Sign in", complete AAD login.
   - Click "Embed" to load the report.

## How it works

> **Note:** This section was generated by GitHub Copilot and should be reviewed for accuracy and completeness.

- The frontend uses MSAL Browser to obtain an AAD access token for the Power BI Service with delegated scopes.
- The JavaScript SDK embeds the report using:
  - `tokenType: Aad`
  - `accessToken: <user AAD token>`
  - `embedUrl: https://app.powerbi.com/reportEmbed?reportId=...&groupId=...`
- No embed token or service principal is used in this flow.

## Switching from "App owns data"

> **Note:** This section was generated by GitHub Copilot and should be reviewed for accuracy and completeness.

- This sample uses user sign-in rather than a service principal.
- Ensure users have direct access to the report in Power BI.

## National clouds

> **Note:** This section was generated by GitHub Copilot and should be reviewed for accuracy and completeness.

Update `POWER_BI_APP_URL` in `src/public/config.js` for your cloud:

- Commercial: `https://app.powerbi.com`
- GCC: `https://app.powerbigov.us`
- Germany: `https://app.powerbi.de`
- China: `https://app.powerbi.cn`

You might also need to adjust the Content Security Policy (CSP) if endpoints differ.

## Troubleshooting

> **Note:** This section was generated by GitHub Copilot and should be reviewed for accuracy and completeness.

- Stuck on sign-in or token errors:
  - Check App Registration redirect URI matches your origin (e.g., `http://localhost:3000`).
  - Confirm delegated permissions include `Report.Read.All` with admin consent.
  - For single-tenant apps, `AAD_TENANT_ID` should be your tenant ID.

- 401/403 on embed:
  - The signed-in user must have permission to the report/workspace.
  - Confirm the workspace and report IDs are correct.

- Nothing renders:
  - Open the browser console for `powerbi-client` errors.
  - Ensure the CSP in `index.html` allows `login.microsoftonline.com` and `app.powerbi.com`.

## Azure AD App Registration: Reply Address (Redirect URI) Error

> **Note:** This section was generated by GitHub Copilot and should be reviewed for accuracy and completeness.

If you see an error like:

    AADSTS500113: No reply address is registered for the application.

This means your Azure AD (Entra ID) App Registration does not have the correct Redirect URI configured.

**How to fix:**

1. Go to the [Azure Portal](https://portal.azure.com/).
2. Navigate to **Azure Active Directory** > **App registrations** > *Your App*.
3. Under **Authentication**, find the **Redirect URIs** section.
4. Add the following URI:

    - `http://localhost:3000`

   (Or the URL where you are running the app.)

5. Click **Save**.

> The Redirect URI must exactly match the URL your app is served from, including protocol (http/https) and port.

If you change the port or deploy to a different host, update the Redirect URI accordingly in the Azure Portal.

## Azure AD App Registration: Single-Page Application (SPA) Required

> **Note:** This section was generated by GitHub Copilot and should be reviewed for accuracy and completeness.

If you see an error like:

    AADSTS9002326: Cross-origin token redemption is permitted only for the 'Single-Page Application' client-type. Request origin: 'http://localhost:3000'.

This means your Azure AD (Entra ID) App Registration is not configured as a Single-Page Application (SPA).

**How to fix:**

1. Go to the [Azure Portal](https://portal.azure.com/).
2. Navigate to **Azure Active Directory** > **App registrations** > *Your App*.
3. Go to the **Authentication** blade.
4. Under **Platform configurations**, click **Add a platform** (or edit the existing one).
5. Select **Single-page application**.
6. Add your redirect URI (e.g., `http://localhost:3000`).
7. Remove any "Web" platform configuration if present (unless you need it for other flows).
8. Click **Save**.

> The Redirect URI must exactly match the URL your app is served from, including protocol (http/https) and port.

If you change the port or deploy to a different host, update the Redirect URI accordingly in the Azure Portal.

## Azure AD App Registration: Setup Guide

> **Note:** This section was generated by GitHub Copilot and should be reviewed for accuracy and completeness.

To use this sample, you must register an application in Azure AD (Entra ID) and configure it for Single-Page Application (SPA) authentication.

**Steps:**

1. Go to the [Azure Portal](https://portal.azure.com/).
2. Navigate to **Azure Active Directory** > **App registrations** > **New registration**.
3. Enter a name for your app (e.g., "Power BI JS Demo").
4. Supported account types: Choose as needed (e.g., Single tenant for demos).
5. Redirect URI:
    - Select **Single-page application (SPA)**
    - Enter: `http://localhost:3000`
6. Click **Register**.

**After registration:**

1. Go to your app registration's **Overview** page.
    - Copy the **Application (client) ID** and **Directory (tenant) ID** for use in `src/public/config.js`.
    - **Application (client) ID**: Copy this value for `AAD_CLIENT_ID` in `src/public/config.js`.
    - **Directory (tenant) ID**: Copy this value for `AAD_TENANT_ID` in `src/public/config.js`.
2. Go to the **Authentication** blade:
    - Ensure the SPA platform is present with the correct redirect URI.
    - Remove any "Web" platform configuration unless needed for other flows.
    - (Optional) Enable Access tokens and ID tokens for implicit grant if required by your scenario.
3. Go to **API permissions**:
    - Click **Add a permission** > **APIs my organization uses** > search for **Power BI Service**.
    - Add **Delegated** permission: `Report.Read.All` (and `Dataset.Read.All` if needed).
    - Click **Grant admin consent** for your tenant.

**Find your Power BI Workspace and Report IDs:**

1. Go to [Power BI Service](https://app.powerbi.com/).
2. Navigate to the desired workspace.
    - The **Workspace ID** is in the URL after `/groups/`, e.g.:
      `https://app.powerbi.com/groups/<workspace-id>/list`
3. Open the report you want to embed.
    - The **Report ID** is in the URL after `/reports/`, e.g.:
      `https://app.powerbi.com/groups/<workspace-id>/reports/<report-id>/ReportSection`
4. Copy these IDs for `POWER_BI_WORKSPACE_ID` and `POWER_BI_REPORT_ID` in `src/public/config.js`.

**Your app registration is now ready to use with this sample.**

---

## Integrating with SharePoint (Custom Web Part)

> **Note:** This section was generated by GitHub Copilot and should be reviewed for accuracy and completeness.

You can integrate this Power BI embedding approach into a custom SharePoint web part. Here are some general steps and considerations:

1. **Create a SharePoint Framework (SPFx) Web Part:**
   - Use [SharePoint Framework (SPFx)](https://learn.microsoft.com/sharepoint/dev/spfx/sharepoint-framework-overview) to build your custom web part.
   - Scaffold a new SPFx project using `yo @microsoft/sharepoint`.

2. **Add Power BI and MSAL dependencies:**
   - Install `powerbi-client` and `@azure/msal-browser` via npm in your SPFx project.
   - Example:
     ```bash
     npm install powerbi-client @azure/msal-browser
     ```

3. **Reuse authentication and embedding logic:**
   - Adapt the authentication and embedding logic from this sample (e.g., from `app.js`, `authConfig.js`, and `config.js`) into your web part's code.
   - Use MSAL to authenticate the user and acquire a token for Power BI.
   - Use the Power BI JavaScript SDK to embed the report in your web part's DOM.

4. **Handle authentication context:**
   - SharePoint may already provide a user context. If so, you may be able to use single sign-on (SSO) or pass the user's token to Power BI.
   - Otherwise, use MSAL as in this sample to prompt the user to sign in.

5. **CSP and iFrame Considerations:**
   - Ensure your SharePoint tenant allows embedding Power BI (see [Power BI in SharePoint](https://learn.microsoft.com/power-bi/collaborate-share/service-embed-report-spo)).
   - Adjust Content Security Policy (CSP) if needed to allow Power BI endpoints.

6. **References:**
   - [Embed Power BI in SharePoint Online](https://learn.microsoft.com/power-bi/collaborate-share/service-embed-report-spo)
   - [SPFx Web Part Docs](https://learn.microsoft.com/sharepoint/dev/spfx/web-parts/overview-client-side-web-parts)
   - [Power BI JavaScript SDK](https://github.com/microsoft/PowerBI-JavaScript)

> Note: For most scenarios, Microsoft recommends using the built-in Power BI web part for SharePoint Online. Use a custom web part only if you need advanced embedding scenarios or custom authentication flows.

## Using SharePoint User Context and SSO for Power BI Embedding

> **Note:** This section was generated by GitHub Copilot and should be reviewed for accuracy and completeness.

When building a custom SharePoint web part, SharePoint may already provide a user context. In some cases, you can leverage Single Sign-On (SSO) or pass the user's token directly to Power BI, avoiding an extra login prompt.

### Approaches

1. **Using SharePoint's Access Token (Recommended for SSO):**
   - In SharePoint Online, you can use the [AADHttpClient](https://learn.microsoft.com/sharepoint/dev/spfx/use-aadhttpclient) from the SharePoint Framework (SPFx) to acquire an access token for the Power BI API on behalf of the current user.
   - This token can then be used to embed Power BI content without prompting the user to sign in again.

2. **Fallback to MSAL Authentication:**
   - If you cannot get a token from SharePoint, use MSAL as in this sample to prompt the user for authentication.

### Example: Get Power BI Token with AADHttpClient in SPFx

```typescript
import { AadHttpClient, AadHttpClientFactory } from '@microsoft/sp-http';

// In your web part or component:
const resource = 'https://analysis.windows.net/powerbi/api'; // Power BI API resource
const aadClient: AadHttpClient = await this.context.aadHttpClientFactory.getClient(resource);

// Acquire token silently for Power BI
const token = await aadClient.getToken(resource);

// Use this token in the Power BI embed config
const embedConfig = {
  type: 'report',
  tokenType: window['powerbi-client'].models.TokenType.Aad,
  accessToken: token,
  embedUrl: 'https://app.powerbi.com/reportEmbed?...',
  id: '<report-id>',
  // ...other config
};
```

**Notes:**
- You must configure the required API permissions (e.g., `Report.Read.All`) in your SharePoint app registration.
- The user must have access to the Power BI report.
- If you get a permissions error, check your SharePoint tenant and app registration settings.

**References:**
- [Use AADHttpClient in SPFx](https://learn.microsoft.com/sharepoint/dev/spfx/use-aadhttpclient)
- [Power BI JavaScript SDK](https://github.com/microsoft/PowerBI-JavaScript)
- [Embed Power BI in SharePoint Online](https://learn.microsoft.com/power-bi/collaborate-share/service-embed-report-spo)

---

## References

- Power BI JavaScript SDK: https://github.com/microsoft/PowerBI-JavaScript
- Embed for your organization: https://learn.microsoft.com/power-bi/developer/embedded/embed-sample-for-your-organization
- MSAL Browser docs: https://learn.microsoft.com/azure/active-directory/develop/msal-overview